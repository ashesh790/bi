{% extends 'theme/master_filter.html' %}
{% load static %}
{% block home %}active{% endblock %}
{% block property %}
<!-- Search Start -->
<div class="col-md-12">
    <div class="tab-content">
        <div id="tab-1" class="tab-pane fade show p-0 active">
            <div class="row g-4 property_counter">
                {% for i in property_data %}
                <div class="col-lg-4 col-md-6 wow fadeInUp" data-wow-delay="0.1s">
                    <div class="property-item rounded overflow-hidden">
                        <div class="position-relative overflow-hidden">
                            <a href="property_details/{{i.id}}"><img class="img-fluid" style="width:100%;"
                                    src="{{i.property_data.property_image|first}}" alt=""></a>
                            <div class="bg-primary rounded text-white position-absolute start-0 top-0 m-4 py-1 px-3">
                                For {{i.property_data.selling_option}}</div>
                            <div
                                class="bg-white rounded-top text-primary position-absolute start-0 bottom-0 mx-4 pt-1 px-3">
                                {{i.property_data.property_type}}</div>
                        </div>
                        <div class="p-4 pb-0">
                            <h5 class="text-primary mb-3">{{i.property_data.property_rent_price}}/Month</h5>
                            <a class="d-block h5 mb-2" href="">{{i.property_data.property_type}}, For
                                {{i.property_data.selling_option}}</a>
                            <p><i
                                    class="fa fa-map-marker-alt text-primary me-2"></i>{{i.property_data.property_address}}
                            </p>
                        </div>
                        <div class="d-flex border-top">
                            <small class="flex-fill text-center border-end py-2"><i
                                    class="fa fa-ruler-combined text-primary me-2"></i>{{i.property_data.geography_area}}</small>
                            <small class="flex-fill text-center border-end py-2"><i
                                    class="fa fa-bed text-primary me-2"></i>{{i.property_data.construction_status}}</small>
                            <small class="flex-fill text-center py-2"><i
                                    class="fa fa-bath text-primary me-2"></i>{{i.property_data.property_age}}
                                Year
                                old</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
</div>
<!-- Search End -->
<script>

    // search by property type 
    function property_type_core(property_type) {
        var property_type = $(property_type).val();
        $.ajax({
            url: "{% url 'search_property_type' %}",
            type: "POST",
            data: {
                csrfmiddlewaretoken: $("[name=csrfmiddlewaretoken]").val(),
                "data": property_type
            },
            success: function (data) {
                if (Object.keys(data).length != 0) {
                    $(".property_counter").empty();
                    for (var [key, val] of Object.entries(data)) {
                        $(".property_counter").append(` 
                        <div class="col-lg-4 col-md-6 wow fadeInUp" data-wow-delay="0.1s">
                            <div class="property-item rounded overflow-hidden">
                                <div class="position-relative overflow-hidden">
                                    <a href=""><img class="img-fluid" src="${val.property_image[0]}" alt=""></a>
                                    <div
                                        class="bg-primary rounded text-white position-absolute start-0 top-0 m-4 py-1 px-3">
                                        For ${val.selling_option}</div>
                                    <div
                                        class="bg-white rounded-top text-primary position-absolute start-0 bottom-0 mx-4 pt-1 px-3">
                                        ${val.property_type}</div>
                                </div>
                                <div class="p-4 pb-0">
                                    <h5 class="text-primary mb-3">${val.property_rent_price}/Month</h5>
                                    <a class="d-block h5 mb-2" href="">${val.property_type}, For ${val.selling_option}</a>
                                    <p><i class="fa fa-map-marker-alt text-primary me-2"></i>${val.property_address}</p>
                                </div>
                                <div class="d-flex border-top">
                                    <small class="flex-fill text-center border-end py-2"><i
                                            class="fa fa-ruler-combined text-primary me-2"></i>${val.geography_area}</small>
                                    <small class="flex-fill text-center border-end py-2"><i
                                            class="fa fa-bed text-primary me-2"></i>${val.construction_status}</small>
                                    <small class="flex-fill text-center py-2"><i class="fa fa-bath text-primary me-2"></i>${val.property_age} Year old</small>
                                </div>
                            </div>
                        </div>
                        `)
                    }
                }
                else {
                    $(".property_counter").empty();
                    $(".property_counter").append("<h1>Result not found</h1>")
                }
            }
        })
    }

    // Search field is applied and trash button for this field is added 
    function search_field_applied(field) {
        var field_id = $(field).attr("id");
        if (`${field_id}_trash_icon`) {
            $(`#${field_id}_trash_icon`).remove();
        }
        $(`#${field_id}__trash`).after(`
        <span class="mx-2 my-2" id="${field_id}_trash_icon" onclick="remove_filter_value(this);"> 
            <i class="fa fa-trash" aria-hidden="true"></i>
        </span>
        `);
    }

    // remove specific filter 
    function remove_filter_value(search_field) {
        var field_name = $(search_field).attr("id");
        real_field_name = field_name.replace("_trash_icon", "");
        $(`#${real_field_name}`).val("");
        search_property_based_on_input_field_values();
        //
        $(`#${field_name}`).remove();
    }

    // search property as per field which is selected in advance filter 
    function search_property_based_on_input_field_values(selling_type = null) {
        var selling_option_val = "";
        if (selling_type != null) {
            selling_option_val = $(selling_type).val();
        }
        else {
            if ($("#sell").hasClass("active")) {
                selling_option_val = "Sell";
            }
            else if ($("#rent").hasClass("active")) {
                selling_option_val = "Rent";
            }
        }
        var country = $('#country_based').val() || "";
        var state = $('#state_based').val() || "";
        var city = $('#city_based').val() || "";
        var construction_status = $('#construction_status').val() || "";
        var bathroom = $('#bathroom_val').val() || "";
        var balcony = $('#balcony_val').val() || "";
        var bhk = $("#bhk_val").val() || "";
        var furnish_type = $('#furnish_type').val() || "";
        var geography_area = $('#geography_val').val() || "";

        var search_object = new Object();
        if (country != "") { search_object.country = country };
        if (state != "") { search_object.state = state };
        if (city != "") { search_object.city = city };
        if (construction_status != "") { search_object.construction_status = construction_status };
        if (bathroom != "") { search_object.bathroom = bathroom };
        if (balcony != "") { search_object.balcony = balcony };
        if (bhk != "") { search_object.bhk = bhk };
        if (furnish_type != "") { search_object.furnish_type = furnish_type };
        if (geography_area != "") { search_object.geography_area = geography_area };
        if (selling_option_val != "") { search_object.selling_option = selling_option_val };

        $.ajax({
            url: "{% url 'search_properties' %}",
            type: "POST",
            data: {
                csrfmiddlewaretoken: $("[name=csrfmiddlewaretoken]").val(),
                "search_object": JSON.stringify(search_object),
            },
            success: function (property_data) {
                var i = 0;
                property_id = property_data["id"];
                property_data = property_data['property_data'];
                console.log(property_data);
                if (property_data) {
                    $(".property_counter").empty();
                    for (var [key, val] of Object.entries(property_data)) {
                        console.log(property_id[i]);
                        $(".property_counter").append(` 
                        <div class="col-lg-4 col-md-6 wow fadeInUp" data-wow-delay="0.1s">
                            <div class="property-item rounded overflow-hidden">
                                <div class="position-relative overflow-hidden">
                                    <a href="/property_details/${property_id[i]}"><img class="img-fluid" src="${val.property_image[0]}" alt=""></a>
                                    <div
                                        class="bg-primary rounded text-white position-absolute start-0 top-0 m-4 py-1 px-3">
                                        For ${val.selling_option}</div>
                                    <div
                                        class="bg-white rounded-top text-primary position-absolute start-0 bottom-0 mx-4 pt-1 px-3">
                                        ${val.property_type}</div>
                                </div>
                                <div class="p-4 pb-0">
                                    <h5 class="text-primary mb-3">${val.property_rent_price}/Month</h5>
                                    <a class="d-block h5 mb-2" href="">${val.property_type}, For ${val.selling_option}</a>
                                    <p><i class="fa fa-map-marker-alt text-primary me-2"></i>${val.property_address}</p>
                                </div>
                                <div class="d-flex border-top">
                                    <small class="flex-fill text-center border-end py-2"><i
                                            class="fa fa-ruler-combined text-primary me-2"></i>${val.geography_area}</small>
                                    <small class="flex-fill text-center border-end py-2"><i
                                            class="fa fa-bed text-primary me-2"></i>${val.construction_status}</small>
                                    <small class="flex-fill text-center py-2"><i class="fa fa-bath text-primary me-2"></i>${val.property_age} Year old</small>
                                </div>
                            </div>
                        </div>
                        `);
                        i++;
                    }
                }
                else {
                    $(".property_counter").empty();
                    $(".property_counter").append("<h1>Result not found</h1>")
                }
            }
        });
    }

    $(document).ready(function (e) {

        // advance filter configuration by country 
        $('#country_based').change(function (e) {
            //alert("Clikced!"); 
            e.preventDefault();
            var country_name = $(this).val();
            //alert(country_name); 
            //var data_target = $(property).text();
            $.ajax({
                url: "{% url 'state_list' %}",
                type: "GET",
                data: {
                    'country_name': country_name,
                },
                success: function (property_data) {
                    $("#state_based").empty();
                    $('#state_based').append(`<option value="">Select state</option>`);
                    $('#state_based').append(`<option hidden>Select stateSelect stateSelect state</option>`);
                    property_data = JSON.parse(property_data)
                    for (let [key, value] of Object.entries(property_data)) {
                        $('#state_based').append(`<option value="${value.iso2}">${value.name}</option>`);
                    }
                }
            });
        });

        // advance filter configuration by state 
        $('#state_based').change(function (e) {
            //alert("Clikced!"); 
            e.preventDefault();
            var country_name = $("#country_based").val();
            var state_name = $(this).val();
            $.ajax({
                url: "{% url 'city_list' %}",
                type: "GET",
                data: {
                    'state_name': state_name,
                    'country_name': country_name,
                },
                success: function (property_data) {
                    $("#city_based").empty();
                    $('#city_based').append(`<option value="">Select City</option>`);
                    $('#city_based').append(`<option hidden>Select stateSelect stateSelect state</option>`);
                    property_data = JSON.parse(property_data)
                    for (let [key, value] of Object.entries(property_data)) {
                        $('#city_based').append(`<option value="${value.name}">${value.name}</option>`);
                    }
                }
            });
        });
    });
</script>
{% endblock %}